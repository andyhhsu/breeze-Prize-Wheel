<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¸é‹è¼ªç›¤å¤§æŠ½ç - Galaxy æ˜Ÿéš›ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- Google tag (gtag.js) - GA4 è©•ä¼° ID -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-S73FN7CZPS"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-S73FN7CZPS');
    </script>

    <style>
        @keyframes slow-pan { 0% { background-position: 0% 0%; } 100% { background-position: 100% 100%; } }
        @keyframes pulse-glow {
            0% { box-shadow: 0 0 8px rgba(59, 130, 246, 0.5), 0 0 0 0 rgba(59, 130, 246, 0.5); }
            70% { box-shadow: 0 0 16px rgba(59, 130, 246, 0.8), 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 8px rgba(59, 130, 246, 0.5), 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        @keyframes prize-glow {
            0% { filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5)); }
            50% { filter: drop-shadow(0 0 15px rgba(255, 255, 255, 1)); }
            100% { filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5)); }
        }
        /* æŒ‰éˆ•å‘¼å¸ç‡ˆæ•ˆæœ */
        @keyframes pulse-button {
            0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(96, 165, 250, 0.6); }
            50% { transform: scale(1.05); box-shadow: 0 0 35px rgba(96, 165, 250, 0.9); }
        }
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow-x: hidden; }
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #0c1326;
            background-image: url('https://www.transparenttextures.com/patterns/stardust.png');
            animation: slow-pan 120s linear infinite alternate;
            color: #e0e7ff;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .main-container {
            background: rgba(19, 28, 57, 0.7);
            border: 1px solid rgba(59, 130, 246, 0.3);
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            transition: box-shadow 0.4s ease, border-color 0.4s ease;
            width: 100%;
            max-width: 500px; /* ç¨å¾®å¢åŠ æœ€å¤§å¯¬åº¦ä»¥é©æ‡‰å¤§è¢å¹• */
        }
        .main-container.official-mode {
            box-shadow: 0 0 0 3px #2563eb, 0 0 25px 0px rgba(37, 99, 235, 0.6);
            border-color: #2563eb;
        }
        .wheel-container {
            position: relative;
            width: 90%; /* ä½¿ç”¨ç™¾åˆ†æ¯”å¯¬åº¦ */
            max-width: 400px; /* é™åˆ¶æœ€å¤§å¯¬åº¦ */
            margin: 0 auto; /* ç°¡åŒ–é–“è·è¨­å®š */
            filter: drop-shadow(0 0 15px rgba(59, 130, 246, 0.4));
            aspect-ratio: 1 / 1;
        }
        .wheel {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 50%; overflow: hidden; border: 4px solid #fff;
            box-shadow: 0 0 20px rgba(255,255,255,0.3), inset 0 0 25px rgba(0,0,0,0.5);
            transition: transform 6s cubic-bezier(0.25, 1, 0.5, 1);
        }
        .prize { position: absolute; top: 50%; left: 50%; width: 1px; height: 1px; transform-origin: center center; }
        .prize > span {
            display: block; transform: translate(-50%, -28vw) rotate(-90deg);
            color: #ffffff; font-weight: 500; font-size: clamp(10px, 3vw, 14px); /* èª¿æ•´å­—é«”å¤§å°ç¯„åœ */
            text-shadow: 0 0 5px rgba(0,0,0,0.8); white-space: nowrap; text-align: center; width: 150px;
        }
        @media (min-width: 500px) { .prize > span { transform: translate(-50%, -125px) rotate(-90deg); font-size: clamp(12px, 3.5vw, 16px); } }
        .pointer {
            position: absolute; top: 50%; left: 50%; width: 20px; height: 20px;
            background: #fff; border-radius: 50%; transform: translate(-50%, -50%);
            z-index: 10; border: 5px solid #fff; box-shadow: 0 0 15px 5px rgba(255, 255, 255, 0.7);
        }
        .pointer::before {
            content: ''; position: absolute; top: -40px; left: 50%;
            transform: translateX(-50%); width: 0; height: 0;
            border-left: 18px solid transparent; border-right: 18px solid transparent;
            border-bottom: 36px solid #fff; filter: drop-shadow(0 -5px 5px rgba(255,255,255,0.5));
        }
        /* å„ªåŒ–å¾Œçš„æŠ½çæŒ‰éˆ•æ¨£å¼ */
        .spin-button {
            background-image: linear-gradient(to right, #3b82f6, #60a5fa);
            border: none;
            transition: all 0.3s ease-in-out;
            color: white; font-weight: 900; 
            font-size: 1.5rem; /* åŠ å¤§å­—é«” */
            padding: 1rem 3rem; /* åŠ å¤§å…§è· */
            border-radius: 50px; /* æ”¹ç‚ºåœ“è§’è† å›Šå½¢ç‹€ */
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
            animation: pulse-button 2.5s infinite ease-in-out; /* å¥—ç”¨å‘¼å¸ç‡ˆå‹•ç•« */
        }
        .spin-button:hover:not(:disabled) {
            animation-play-state: paused; /* æ‡¸åœæ™‚æš«åœå‹•ç•« */
            transform: scale(1.05) translateY(-2px); /* æ”¾å¤§æ•ˆæœ */
            box-shadow: 0 0 40px rgba(96, 165, 250, 1);
        }
        .spin-button:disabled { 
            opacity: 0.4; 
            cursor: not-allowed; 
            background: #374151; 
            box-shadow: none; 
            animation: none; /* ç¦ç”¨æ™‚ç§»é™¤å‹•ç•« */
        }
        .spin-button:not(:disabled):active { 
            transform: translateY(1px) scale(1.02);
        }
        .modal-backdrop { background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); }
        .modal-content {
            background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(59, 130, 246, 0.4);
            backdrop-filter: blur(15px); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .staff-login-button {
            position: fixed; bottom: 20px; right: 20px; z-index: 10001;
            background-color: #1d4ed8; color: white; border-radius: 50%;
            width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;
            border: 2px solid rgba(255,255,255,0.5); cursor: pointer; transition: all 0.3s;
            animation: pulse-glow 2s infinite;
        }
        .staff-login-button:hover { transform: scale(1.1); animation-play-state: paused; }
        .settings-panel {
            position: fixed; top: 0; right: -100%; width: 100%; max-width: 400px; height: 100%;
            background-color: #1e293b; padding: 2rem; box-shadow: -10px 0 20px rgba(0,0,0,0.3);
            transition: right 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); z-index: 10002; overflow-y: auto;
        }
        .settings-panel.open { right: 0; }
        .settings-toggle-button { position: fixed; top: 20px; right: 20px; z-index: 10003; }
    </style>
</head>
<body>
    <div class="flex items-center justify-center min-h-screen w-full p-2">
        <div id="mainContainer" class="main-container p-4 rounded-3xl text-center">
            <div id="officialModeBanner" class="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-blue-600 text-white font-bold px-4 py-1 rounded-full text-sm shadow-lg opacity-0 transition-opacity duration-300 pointer-events-none">
                å®˜æ–¹æŠ½çæ¨¡å¼
            </div>
            <h1 id="mainTitle" class="text-2xl sm:text-3xl font-bold text-white mb-1" style="text-shadow: 0 0 10px rgba(96, 165, 250, 0.7);">LUCKY WHEEL</h1>
            <p class="text-slate-300 mb-2 text-sm sm:text-base">é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼ŒæŠ½å‡ºä½ çš„å°ˆå±¬å¹¸é‹ï¼</p>
            
            <!-- å¤§çé å‘Š -->
            <div id="grand-prize-container" class="my-3 p-3 bg-slate-900/50 rounded-lg flex items-center justify-center gap-4 border border-blue-500/30">
                <div class="w-20 h-20 sm:w-24 sm:h-24 bg-white/10 rounded-full p-2 flex items-center justify-center">
                    <img id="grand-prize-image" src="https://raw.githubusercontent.com/andyhhsu/breeze-Prize-Wheel/main/175000-removebg-preview.png" alt="Grand Prize" class="w-full h-full object-contain" style="animation: prize-glow 3s infinite;">
                </div>
                <div>
                    <h3 class="text-3xl font-bold text-cyan-400">ä»Šæ—¥é™å®šå¤§ç</h3>
                    <p id="grand-prize-name" class="text-3xl font-bold text-white">è¡Œå‹•é›»æº</p>
                </div>
            </div>

            <div class="wheel-container my-3">
                <div class="wheel" id="wheel"></div>
                <div class="pointer"></div>
            </div>
            <div class="mt-4">
                <button id="spinButton" class="spin-button">é–‹å§‹æŠ½ç</button>
            </div>

            <!-- å³æ™‚å¾—çæ¦œ -->
            <div id="winner-board-container" class="mt-3 h-12 sm:h-16 overflow-hidden relative">
                <div id="winner-list" class="absolute top-0 left-0 w-full text-sm sm:text-base">
                    <!-- å¾—çåå–®å°‡ç”±JSå‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <!-- çµæœå½ˆå‡ºè¦–çª— -->
    <div id="resultModal" class="result-modal modal-backdrop fixed inset-0 flex items-center justify-center opacity-0 pointer-events-none transform scale-90 z-[10001]">
        <div class="modal-content p-8 rounded-2xl w-11/12 max-w-md text-center">
            <h2 id="resultTitle" class="text-2xl font-bold text-white mb-4"></h2>
            <p id="resultText" class="text-4xl md:text-5xl font-bold text-cyan-400 my-6" style="text-shadow: 0 0 15px rgba(56, 189, 248, 0.7);"></p>
            <div id="resultInstructions" class="mt-6"></div>
            <button id="closeModalButton" class="spin-button mt-6">å¤ªæ£’äº†ï¼</button>
        </div>
    </div>
    
    <canvas id="confetti-canvas" class="fixed top-0 left-0 w-full h-full pointer-events-none z-[9999]"></canvas>

    <!-- å¾Œå°è¨­å®šæŒ‰éˆ• (é è¨­éš±è—) -->
    <div id="settings-toggle" class="settings-toggle-button bg-slate-600 text-white rounded-full w-12 h-12 items-center justify-center shadow-lg cursor-pointer" style="display: none;">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
    </div>
    
    <!-- å®˜æ–¹æ¨¡å¼å•Ÿå‹•æŒ‰éˆ• -->
    <div id="staff-login" class="staff-login-button">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
    </div>

    <!-- å¾Œå°è¨­å®šé¢æ¿ -->
    <div id="settings-panel" class="settings-panel text-white">
        <h2 class="text-2xl font-bold mb-6">çé …è¨­å®š (å®˜æ–¹æ¨¡å¼)</h2>
        <div class="mb-6">
            <label for="title-input" class="block mb-2 text-sm font-medium text-gray-300">æ´»å‹•ä¸»æ¨™é¡Œ</label>
            <input type="text" id="title-input" class="bg-slate-800 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="è¼¸å…¥æ´»å‹•ä¸»æ¨™é¡Œ">
        </div>
        <div id="prize-list" class="space-y-4"></div>
        <button id="add-prize" class="mt-6 w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">æ–°å¢çé …</button>
        <button id="save-settings" class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded">å„²å­˜è¨­å®šä¸¦æ›´æ–°è½‰ç›¤</button>
        <p class="text-xs text-gray-400 mt-4">å®˜æ–¹æ¨¡å¼çš„è¨­å®šå°‡æœƒè‡ªå‹•å„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­ã€‚</p>
    </div>

    <!-- åº—å“¡å¯†ç¢¼é©—è­‰å½ˆçª— -->
    <div id="authModal" class="auth-modal modal-backdrop fixed inset-0 flex items-center justify-center z-[10002] opacity-0 pointer-events-none">
        <div class="modal-content p-8 rounded-2xl w-11/12 max-w-sm text-center">
            <h2 class="text-2xl font-bold text-white mb-4">åº—å“¡æˆæ¬Š</h2>
            <p class="text-slate-300 mb-6">è«‹è¼¸å…¥å¯†ç¢¼ä»¥å•Ÿå‹•å®˜æ–¹æŠ½çæ¨¡å¼ã€‚</p>
            <input type="password" id="passwordInput" class="w-full p-3 rounded bg-slate-800/50 border border-slate-600 text-white text-center text-2xl tracking-widest focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢">
            <p id="passwordError" class="text-red-400 h-6 mt-2 text-sm"></p>
            <div class="flex gap-4 mt-2">
                <button id="cancelUnlockButton" class="w-full bg-slate-600 hover:bg-slate-500 text-white font-bold py-3 rounded-lg">å–æ¶ˆ</button>
                <button id="unlockButton" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg">ç™»å…¥</button>
            </div>
        </div>
    </div>


    <script>
        // --- 0. æ´»å‹•è¨­å®š ---
        const STAFF_PASSWORD = 'samsung888';
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxzoKarPMeTMXOxUciPWQisJRThU1Pq5VKvTVn4mQySw0GKAFyHxbSX-gcAu0WKSqNg/exec'; 
        
        // æ¨¡æ“¬æŠ½ççé …è¨­å®š
        const SIMULATION_PRIZES = {
            title: 'è½‰å‹•ä½ çš„ä¸‰æ˜Ÿå¹¸é‹è½‰ç›¤',
            prizes: [
                { text: '10,000mAhè¡Œå‹•é›»æº', color: '#1e3a8a', weight: 1 },
                { text: 'ç’°ä¿é¤å…·çµ„', color: '#1e40af', weight: 3 },
                { text: 'çš®é©é£²æ–™è¢‹', color: '#1d4ed8', weight: 6 },
                { text: 'æ‘ºç–Šæ‰‡', color: '#2563eb', weight: 9 },
                { text: 'Zç³»åˆ—å…è²»å°å‡å¤§', color: '#3b82f6', weight: 13 },
                { text: 'æ½›æ°´è‰‡æ”¶ç´ç›’', color: '#60a5fa', weight: 18 },
                { text: 'AIå¸†å¸ƒè¢‹', color: '#93c5fd', weight: 23 },
                { text: 'é›»å®¹å¼è§¸æ§ç­†', color: '#bfdbfe', weight: 27 },
            ]
        };

        // å®˜æ–¹æŠ½çé è¨­çé …è¨­å®š
        const DEFAULT_OFFICIAL_PRIZES = {
            title: 'ä¸‰æ˜Ÿå¹¸é‹è½‰ç›¤-å®˜æ–¹æŠ½ç',
            prizes: [
                { text: '10,000mAhè¡Œå‹•é›»æº', color: '#1e3a8a', weight: 1 },
                { text: 'ç’°ä¿é¤å…·çµ„', color: '#1e40af', weight: 3 },
                { text: 'çš®é©é£²æ–™è¢‹', color: '#1d4ed8', weight: 6 },
                { text: 'æ‘ºç–Šæ‰‡', color: '#2563eb', weight: 9 },
                { text: 'æ”œå¸¶å¼é…’ç²¾', color: '#3b82f6', weight: 13 },
                { text: 'æ½›æ°´è‰‡æ”¶ç´ç›’', color: '#60a5fa', weight: 18 },
                { text: 'AIå¸†å¸ƒè¢‹', color: '#93c5fd', weight: 23 },
                { text: 'é›»å®¹å¼è§¸æ§ç­†', color: '#bfdbfe', weight: 27 },
            ]
        };


        // --- 1. DOM å…ƒç´  & å…¨åŸŸè®Šæ•¸ ---
        const mainContainer = document.getElementById('mainContainer');
        const mainTitle = document.getElementById('mainTitle');
        const wheel = document.getElementById('wheel');
        const spinButton = document.getElementById('spinButton');
        const resultModal = document.getElementById('resultModal');
        const resultTitle = document.getElementById('resultTitle');
        const resultText = document.getElementById('resultText');
        const resultInstructions = document.getElementById('resultInstructions');
        const closeModalButton = document.getElementById('closeModalButton');
        const confettiCanvas = document.getElementById('confetti-canvas');
        const ctx = confettiCanvas.getContext('2d');
        const settingsPanel = document.getElementById('settings-panel');
        const settingsToggle = document.getElementById('settings-toggle');
        const prizeListContainer = document.getElementById('prize-list');
        const addPrizeButton = document.getElementById('add-prize');
        const saveSettingsButton = document.getElementById('save-settings');
        const staffLoginButton = document.getElementById('staff-login');
        const authModal = document.getElementById('authModal');
        const passwordInput = document.getElementById('passwordInput');
        const unlockButton = document.getElementById('unlockButton');
        const cancelUnlockButton = document.getElementById('cancelUnlockButton');
        const passwordError = document.getElementById('passwordError');
        const officialModeBanner = document.getElementById('officialModeBanner');
        const titleInput = document.getElementById('title-input');
        const grandPrizeName = document.getElementById('grand-prize-name');
        const winnerList = document.getElementById('winner-list');

        let prizes = [];
        let isSpinning = false;
        let currentRotation = 0;
        let isOfficialMode = false;
        let tempSettings = {};

        // --- 2. éŸ³æ•ˆè¨­å®š ---
        let audioInitialized = false;
        let tickSynth, winSynth;

        function initAudio() {
            if (audioInitialized || typeof Tone === 'undefined') return;
            try {
                tickSynth = new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 0.1, sustain: 0.01, release: 0.1 } }).toDestination();
                winSynth = new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'triangle' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.5 } }).toDestination();
                audioInitialized = true;
            } catch (error) { console.error("éŸ³æ•ˆåˆå§‹åŒ–å¤±æ•—:", error); }
        }

        // --- 3. è½‰ç›¤æ ¸å¿ƒåŠŸèƒ½ ---
        function createWheel() {
            wheel.innerHTML = '';
            if (prizes.length === 0) {
                wheel.style.background = '#334155';
                const emptyText = document.createElement('div');
                emptyText.textContent = "è«‹å…ˆè¨­å®šçé …";
                emptyText.className = "flex items-center justify-center h-full text-2xl font-bold text-slate-400";
                wheel.appendChild(emptyText);
                spinButton.disabled = true;
                return;
            };
            spinButton.disabled = prizes.length < 2;

            const numPrizes = prizes.length;
            const prizeAngle = 360 / numPrizes;
            
            const gradient = prizes.map((p, i) => `${p.color} ${i * prizeAngle}deg ${(i + 1) * prizeAngle}deg`).join(', ');
            wheel.style.background = `conic-gradient(from -90deg, ${gradient})`;

            prizes.forEach((prize, i) => {
                const rotation = i * prizeAngle + prizeAngle / 2;
                const prizeElement = document.createElement('div');
                prizeElement.classList.add('prize');
                prizeElement.style.transform = `rotate(${rotation}deg)`;
                const prizeText = document.createElement('span');
                prizeText.textContent = prize.text;
                prizeElement.appendChild(prizeText);
                wheel.appendChild(prizeElement);
            });
        }

        spinButton.addEventListener('click', () => {
            if (isSpinning || spinButton.disabled) return;
            
            if (!audioInitialized && typeof Tone !== 'undefined') {
                Tone.start().then(initAudio);
            }

            gtag('event', 'spin_the_wheel', {
              'event_category': 'engagement',
              'event_label': isOfficialMode ? 'official_mode_spin' : 'play_mode_spin'
            });

            isSpinning = true;
            spinButton.disabled = true;

            const winnerIndex = getWinnerByWeight();
            if (winnerIndex === -1) {
                showResult({ text: "çé …è¨­å®šéŒ¯èª¤ï¼Œç„¡æ³•æŠ½ç" }, false);
                isSpinning = false;
                spinButton.disabled = false;
                return;
            }
            const wonPrize = prizes[winnerIndex];
            
            const numPrizes = prizes.length;
            const prizeAngle = 360 / numPrizes;
            const winnerCenterAngle = winnerIndex * prizeAngle + prizeAngle / 2;
            const targetRotation = -winnerCenterAngle;
            const randomSpins = (5 + Math.floor(Math.random() * 4)) * 360;
            const newRotation = currentRotation - (currentRotation % 360) + randomSpins + targetRotation;
            currentRotation = newRotation;
            
            wheel.style.transform = `rotate(${currentRotation}deg)`;
            
            let tickCount = 0;
            const tickInterval = setInterval(() => {
                if (tickSynth) { tickSynth.triggerAttackRelease('C6', '8n'); }
                if (++tickCount > 80) { clearInterval(tickInterval); }
            }, 70);

            setTimeout(() => {
                clearInterval(tickInterval);
                showResult(wonPrize, isOfficialMode);
                logResultToSheet(wonPrize, isOfficialMode);
                isSpinning = false;
            }, 6000);
        });

        function getWinnerByWeight() {
            const totalWeight = prizes.reduce((sum, prize) => sum + prize.weight, 0);
            if (totalWeight <= 0) return -1;
            let randomNum = Math.random() * totalWeight;
            for (let i = 0; i < prizes.length; i++) {
                if (randomNum < prizes[i].weight) return i;
                randomNum -= prizes[i].weight;
            }
            return prizes.length - 1;
        }

        // --- 4. çµæœé¡¯ç¤º & ç‰¹æ•ˆ ---
        function showResult(prize, isOfficial) {
            resultTitle.textContent = isOfficial ? 'æ­å–œæ‚¨æŠ½ä¸­ï¼' : 'æ­å–œå®Œæˆæ¨¡æ“¬æŠ½ç';
            resultText.textContent = prize.text;

            gtag('event', 'show_result', {
              'event_category': 'conversion',
              'event_label': isOfficial ? 'official_mode_win' : 'play_mode_win',
              'value': prize.text
            });

            if (isOfficial) {
                resultInstructions.innerHTML = '';
                resultInstructions.style.display = 'none';
                closeModalButton.textContent = 'å¤ªæ£’äº†ï¼';
                if (prize.text !== 'éŠ˜è¬æƒ é¡§') {
                    if (winSynth) winSynth.triggerAttackRelease(['C4', 'E4', 'G4', 'C5'], '0.5s');
                    startConfetti();
                } else {
                    if (winSynth) winSynth.triggerAttackRelease(['C3', 'A2'], '0.5s');
                }
            } else {
                resultInstructions.style.display = 'block';
                resultInstructions.innerHTML = `
                    <div class="flex flex-col md:flex-row items-center justify-center text-center md:text-left">
                        <div class="flex-1">
                            <p class="font-bold text-lg text-cyan-400 mb-2">æƒ³è©¦è©¦çœŸæ­£çš„å¥½æ‰‹æ°£å—ï¼Ÿ</p>
                            <ol class="list-decimal list-inside space-y-1">
                                <li>æ‰¾åˆ°æˆ‘å€‘ç†±æƒ…çš„é–€å¸‚å¤¥ä¼´ï¼</li>
                                <li>æƒæQR Codeï¼ŒåŠ å…¥å®˜æ–¹LINE@ã€‚</li>
                                <li>å³å¯å•Ÿå‹•ã€Œå®˜æ–¹æŠ½çã€ï¼ŒæŠŠå¤¢å¹»å¥½ç¦®å¸¶å›å®¶ï¼</li>
                            </ol>
                        </div>
                        <div class="mt-4 md:mt-0 md:ml-6 flex-shrink-0">
                            <img src="https://raw.githubusercontent.com/andyhhsu/breeze-Prize-Wheel/main/LINE.png?raw=true" onerror="this.onerror=null;this.src='https://placehold.co/128x128/ffffff/000000?text=QR+Code';" alt="QR Code" class="w-32 h-32 rounded-lg bg-white p-1">
                        </div>
                    </div>
                `;
                closeModalButton.textContent = 'äº†è§£ï¼';
            }
            
            resultModal.classList.remove('opacity-0', 'pointer-events-none', 'scale-90');
        }
        
        function hideResult() {
            resultModal.classList.add('opacity-0', 'pointer-events-none', 'scale-90');
            stopConfetti();
            if (isOfficialMode) {
                exitOfficialMode();
            } else {
                spinButton.disabled = prizes.length < 2;
            }
        }

        closeModalButton.addEventListener('click', hideResult);
        resultModal.addEventListener('click', (e) => { if (e.target === resultModal) hideResult(); });

        // --- 5. å½©å¸¶å‹•ç•« ---
        let confettiParticles = [];
        let animationFrameId;

        function startConfetti() {
            confettiCanvas.width = window.innerWidth;
            confettiCanvas.height = window.innerHeight;
            confettiParticles = [];
            const particleCount = 200;
            const colors = ['#22d3ee', '#67e8f9', '#a5f3fc', '#ecfeff'];
            for (let i = 0; i < particleCount; i++) {
                confettiParticles.push({
                    x: Math.random() * confettiCanvas.width, y: -20,
                    w: Math.random() * 10 + 5, h: Math.random() * 10 + 5,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    speed: Math.random() * 3 + 2, angle: Math.random() * Math.PI * 2,
                });
            }
            animateConfetti();
        }

        function animateConfetti() {
            ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
            confettiParticles.forEach((p, i) => {
                p.y += p.speed;
                p.x += Math.sin(p.angle + p.y * 0.1) * 2;
                p.angle += 0.1;
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.rect(p.x, p.y, p.w, p.h);
                ctx.fill();
                if (p.y > confettiCanvas.height) { confettiParticles.splice(i, 1); }
            });
            if (confettiParticles.length > 0) {
                animationFrameId = requestAnimationFrame(animateConfetti);
            } else {
                ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
            }
        }
        
        function stopConfetti() {
            confettiParticles = [];
            if (animationFrameId) { cancelAnimationFrame(animationFrameId); }
            ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
        }

        // --- 6. å¾Œå°è¨­å®šé¢æ¿é‚è¼¯ ---
        function renderPrizeSettings(settings) {
            tempSettings = JSON.parse(JSON.stringify(settings));
            titleInput.value = tempSettings.title || 'LUCKY WHEEL';
            prizeListContainer.innerHTML = '';
            tempSettings.prizes.forEach((prize, index) => {
                const prizeItem = document.createElement('div');
                prizeItem.className = 'p-4 bg-slate-700 rounded-lg flex flex-col space-y-3';
                prizeItem.innerHTML = `
                    <div class="flex items-center justify-between">
                        <label class="font-bold">çé … ${index + 1}</label>
                        <button data-index="${index}" class="remove-prize text-red-400 hover:text-red-600 font-bold">ç§»é™¤</button>
                    </div>
                    <input type="text" value="${prize.text}" data-index="${index}" data-key="text" class="prize-input w-full p-2 rounded bg-slate-800 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="çé …åç¨±">
                    <div class="flex items-center space-x-2">
                        <label class="text-sm">é¡è‰²:</label>
                        <input type="color" value="${prize.color}" data-index="${index}" data-key="color" class="prize-input h-8 w-12 p-1 bg-slate-800 border border-slate-600 rounded cursor-pointer">
                        <label class="text-sm ml-auto">æ¬Šé‡:</label>
                        <input type="number" value="${prize.weight}" data-index="${index}" data-key="weight" class="prize-input w-20 p-2 rounded bg-slate-800 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500" min="1" placeholder="æ¬Šé‡">
                    </div>
                `;
                prizeListContainer.appendChild(prizeItem);
            });
        }
        
        prizeListContainer.addEventListener('change', (e) => {
            if (e.target.classList.contains('prize-input')) {
                const index = parseInt(e.target.dataset.index);
                const key = e.target.dataset.key;
                const value = e.target.type === 'number' ? parseInt(e.target.value) || 1 : e.target.value;
                tempSettings.prizes[index][key] = value;
            }
        });

        prizeListContainer.addEventListener('click', (e) => {
             if (e.target.classList.contains('remove-prize')) {
                const index = parseInt(e.target.dataset.index);
                tempSettings.prizes.splice(index, 1);
                renderPrizeSettings(tempSettings);
            }
        });

        addPrizeButton.addEventListener('click', () => {
            tempSettings.prizes.push({ text: 'æ–°çé …', color: '#1e40af', weight: 10 });
            renderPrizeSettings(tempSettings);
        });

        saveSettingsButton.addEventListener('click', () => {
            tempSettings.title = titleInput.value.trim() || 'è½‰å‹•ä½ çš„ä¸‰æ˜Ÿå¹¸é‹è¼ªç›¤';
            tempSettings.prizes = tempSettings.prizes.filter(p => p.text && p.text.trim() !== '');

            if (tempSettings.prizes.length < 2) {
                saveSettingsButton.textContent = 'è«‹è‡³å°‘è¨­å®šå…©å€‹çé …ï¼';
                saveSettingsButton.classList.add('bg-red-500');
                setTimeout(() => {
                    saveSettingsButton.textContent = 'å„²å­˜è¨­å®šä¸¦æ›´æ–°è½‰ç›¤';
                    saveSettingsButton.classList.remove('bg-red-500');
                }, 2000);
                return;
            }
            prizes = JSON.parse(JSON.stringify(tempSettings.prizes));
            mainTitle.textContent = tempSettings.title;
            
            saveSettingsToStorage({ title: tempSettings.title, prizes: prizes });
            createWheel();
            updateGrandPrizeDisplay();
            settingsPanel.classList.remove('open');
        });

        // --- 7. æœ¬åœ°å„²å­˜é‚è¼¯ (for Official Mode) ---
        function saveSettingsToStorage(settings) {
            localStorage.setItem('officialLuckyWheelSettings', JSON.stringify(settings));
        }

        function loadOfficialPrizes() {
            const storedSettings = localStorage.getItem('officialLuckyWheelSettings');
            const settings = storedSettings ? JSON.parse(storedSettings) : DEFAULT_OFFICIAL_PRIZES;
            prizes = settings.prizes;
            mainTitle.textContent = settings.title;
            createWheel();
            updateGrandPrizeDisplay();
        }

        function loadSimulationPrizes() {
            const settings = SIMULATION_PRIZES;
            prizes = settings.prizes;
            mainTitle.textContent = settings.title;
            createWheel();
            updateGrandPrizeDisplay();
        }

        // --- 8. å®˜æ–¹æ¨¡å¼èˆ‡å¾Œç«¯ç´€éŒ„ ---
        function enterOfficialMode() {
            isOfficialMode = true;
            mainContainer.classList.add('official-mode');
            officialModeBanner.classList.remove('opacity-0');
            spinButton.textContent = 'é€²è¡Œå®˜æ–¹æŠ½ç';
            spinButton.disabled = false;
            authModal.classList.add('opacity-0', 'pointer-events-none');
            settingsToggle.style.display = 'flex';
            loadOfficialPrizes(); // è¼‰å…¥å®˜æ–¹çé …
            gtag('event', 'enter_official_mode', { 'event_category': 'staff_action' });
        }

        function exitOfficialMode() {
            isOfficialMode = false;
            mainContainer.classList.remove('official-mode');
            officialModeBanner.classList.add('opacity-0');
            spinButton.textContent = 'é–‹å§‹æŠ½ç';
            settingsToggle.style.display = 'none';
            settingsPanel.classList.remove('open');
            loadSimulationPrizes(); // è¼‰å…¥æ¨¡æ“¬çé …
        }

        function logResultToSheet(prize, isOfficial) {
            if (!GOOGLE_SCRIPT_URL) return;
            const data = { prize: prize.text, mode: isOfficial ? 'å®˜æ–¹' : 'è©¦ç©' };
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST', mode: 'no-cors', cache: 'no-cache',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).catch(err => console.error('Error logging to sheet:', err));
        }

        staffLoginButton.addEventListener('click', () => {
            passwordInput.value = '';
            passwordError.textContent = '';
            authModal.classList.remove('opacity-0', 'pointer-events-none');
            passwordInput.focus();
        });
        
        settingsToggle.addEventListener('click', () => {
            const currentSettings = { title: mainTitle.textContent, prizes: prizes };
            renderPrizeSettings(currentSettings);
            settingsPanel.classList.toggle('open');
        });

        function handleUnlockAttempt() {
            passwordError.textContent = '';
            if (passwordInput.value === STAFF_PASSWORD) {
                enterOfficialMode();
            } else {
                passwordError.textContent = 'å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦ã€‚';
                passwordInput.select();
            }
        }

        unlockButton.addEventListener('click', handleUnlockAttempt);
        passwordInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleUnlockAttempt(); });
        cancelUnlockButton.addEventListener('click', () => { authModal.classList.add('opacity-0', 'pointer-events-none'); });

        // --- 9. æ–°åŠŸèƒ½ï¼šå¤§çèˆ‡å¾—çæ¦œ ---
        function updateGrandPrizeDisplay() {
            if (prizes.length > 0) {
                const grandPrize = [...prizes]
                    .filter(p => p.text !== 'éŠ˜è¬æƒ é¡§' && p.text.toLowerCase().indexOf('thank') === -1) // æ›´å¤šå…ƒçš„æ„Ÿè¬è©éæ¿¾
                    .sort((a, b) => a.weight - b.weight)[0];
                
                if (grandPrize) {
                    grandPrizeName.textContent = grandPrize.text;
                }
            }
        }

        async function fetchLatestWinners() {
            if (!GOOGLE_SCRIPT_URL) return;
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getWinners`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                updateWinnerBoard(data.winners);
            } catch (error) {
                console.error('Error fetching winners:', error);
                winnerList.innerHTML = `<p class="text-slate-500 text-center py-4">ç„¡æ³•è¼‰å…¥å¾—çç´€éŒ„...</p>`;
            }
        }

        function updateWinnerBoard(winners) {
            if (!winners || winners.length === 0) {
                winnerList.innerHTML = `<p class="text-slate-400 text-center py-4">ç›®å‰å°šç„¡å¾—çç´€éŒ„ï¼Œå¿«ä¾†æŒ‘æˆ°ï¼</p>`;
                return;
            }
            winnerList.innerHTML = winners.map(winner => 
                `<p class="text-center py-2 text-slate-300">ğŸ‰ æ­å–œä¸€ä½å¹¸é‹é¡§å®¢æŠ½ä¸­ <span class="font-bold text-cyan-400">${winner.prize}</span>ï¼</p>`
            ).join('');
        }

        // --- 10. åˆå§‹åŒ– ---
        window.onload = () => {
            exitOfficialMode(); // é è¨­ä»¥æ¨¡æ“¬æ¨¡å¼å•Ÿå‹•
            fetchLatestWinners();
            setInterval(fetchLatestWinners, 30000);
        };

        window.onresize = () => {
            stopConfetti();
            if (confettiCanvas) {
                confettiCanvas.width = window.innerWidth;
                confettiCanvas.height = window.innerHeight;
            }
        };
    </script>
</body>
</html>
